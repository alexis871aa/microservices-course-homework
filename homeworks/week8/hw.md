# üß± –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî –ù–µ–¥–µ–ª—è 8
**–ö—É—Ä—Å: ¬´–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã, –∫–∞–∫ –≤ BigTech 2.0¬ª**

---

## üìå –ó–∞–¥–∞–Ω–∏–µ

–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –≤—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç–µ –µ–¥–∏–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ Envoy Proxy:

1. Envoy –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç HTTP‚ÜîHTTP –Ω–∞ `OrderService`.
2. Envoy —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏—Ä—É–µ—Ç HTTP‚ÜîgRPC –Ω–∞ `InventoryService` (JSON‚ÜîgRPC) —á–µ—Ä–µ–∑ `grpc_json_transcoder`.
3. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ —á–µ—Ä–µ–∑ `ext_authz` —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –≤ `IAM`.
4. –í `IAM` —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä—É—á–∫—É `Check` –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É Envoy ext_authz (gRPC).

---

### ‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

1) Envoy –∫–∞–∫ —à–ª—é–∑:
- –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ `envoy.yaml` (–≤ `deploy/envoy/envoy.yaml`).
- –°–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å listener —Å HTTP-—Ñ–∏–ª—å—Ç—Ä–∞–º–∏: `envoy.filters.http.ext_authz` –∏ `envoy.filters.http.grpc_json_transcoder`.
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã:
  - `/order` ‚Üí –∫–ª–∞—Å—Ç–µ—Ä `order_service` (HTTP‚ÜîHTTP, –±–µ–∑ —Ç—Ä–∞–Ω—Å–∫–æ–¥–µ—Ä–∞).
  - `/inventory` ‚Üí –∫–ª–∞—Å—Ç–µ—Ä `inventory_service` (HTTP‚ÜîgRPC —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω—Å–∫–æ–¥–µ—Ä).

2) HTTP‚ÜîHTTP –¥–ª—è OrderService:
- –ü—Ä–æ–±—Ä–æ—Å –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤/–ø—É—Ç–µ–π –ø–æ–¥ `/order` –Ω–∞ –∞–ø—Å—Ç—Ä–∏–º `OrderService` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.

3) HTTP‚ÜîgRPC –¥–ª—è InventoryService:
- –ü–æ–¥–∫–ª—é—á–∏—Ç—å `grpc_json_transcoder` —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –∏ —Å–µ—Ä–≤–∏—Å–∞, —á—Ç–æ–±—ã REST-–∑–∞–ø—Ä–æ—Å—ã –∫ `/inventory/...` –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ gRPC –º–µ—Ç–æ–¥—ã `InventoryService` –∏ –æ–±—Ä–∞—Ç–Ω–æ.

4) –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ IAM:
- –í–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä `ext_authz` –¥–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤.
- –ò—Å–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/auth/login`, `/auth/register`, `/healthz`).
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `IAM` gRPC-—Å–µ—Ä–≤–∏—Å `envoy.service.auth.v3.Authorization/Check`. –ù–∞ —É—Å–ø–µ—Ö ‚Äî 200/OK, –Ω–∞ –æ—Ç–∫–∞–∑ ‚Äî 401/403. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å user-id/roles –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---


## üîê –ö–æ–Ω—Ç—Ä–∞–∫—Ç IAM –¥–ª—è ext_authz

- gRPC: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `envoy.service.auth.v3.Authorization` —Å –º–µ—Ç–æ–¥–æ–º `Check`.
- –ù–∞ –≤—Ö–æ–¥: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ (–∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—É—Ç—å, –º–µ—Ç–æ–¥). –ù–∞ –≤—ã—Ö–æ–¥: `OK`/`Denied` –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.
- –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º–æ—Ç—Ä–∏—Ç–µ protobuf Envoy: `envoy/service/auth/v3/external_auth.proto`.

–ü–æ–ª–µ–∑–Ω–æ: –≤ `week6/contracts/iam_service_contracts.md` –ª–µ–∂–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ IAM.

---

## üõ† –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –¥–ª—è `grpc_json_transcoder` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `inventory.pb`) –≤ –æ–±—Ä–∞–∑–µ Envoy (`/etc/envoy/`).
- –î–ª—è gRPC-–∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –≤–∫–ª—é—á–∞–π—Ç–µ `http2_protocol_options: {}`.
- –ü—Ä–æ–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏ (`/healthz`, `/metrics`, `/readyz`) –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–∏–±–æ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É `virtual_host`.
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–µ—Ä–∂–∏—Ç–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (`deploy/envoy/envoy.yaml`) –∏ —Å–Ω–∞–±–¥–∏—Ç–µ –ø—Ä–æ—Å—Ç—ã–º `docker-compose` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

---

## üí° –ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏

- –ï—Å–ª–∏ REST-—Ä–æ—É—Ç—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å gRPC –º–µ—Ç–æ–¥–∞–º–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `auto_mapping: true` –∏/–∏–ª–∏ —è–≤–Ω–æ –æ–ø–∏—à–∏—Ç–µ HTTP rules –≤ proto —á–µ—Ä–µ–∑ `google.api.http` (–∏ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä).
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –≤–∫–ª—é—á–∏—Ç–µ –ª–æ–≥–∏ Envoy –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º `ext_authz`, `router`, `upstream`.
- –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ç—Ä–∞–Ω—Å–∫–æ–¥–µ—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–±—Ä–∞–Ω —Å —Ç–µ–º –∂–µ proto, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `InventoryService`.

---

**–ê–≤—Ç–æ—Ä –∫—É—Ä—Å–∞: –û–ª–µ–≥ –ö–æ–∑—ã—Ä–µ–≤, 2025**
